---
editor: 
  markdown: 
    wrap: 72
---

# Manipuler des fichiers parquets avec duckdb {.backgroundTitre}

## Quâ€™est-ce que duckdb ?

DuckDB est un projet open-source qui propose un moteur SQL optimisÃ© pour **rÃ©aliser des travaux dâ€™analyse statistique sur des bases de donnÃ©es**.  

Plusieurs avantages :  

- Un **moteur portable** utilisable avec **plusieurs langages** (R, Python, Javascript...) et **plusieurs OS** (Windows, Linux, MacOS...)  
- Une **installation** et une **utilisation** trÃ¨s **facile**  

- Un **moteur SQL** capable d'utiliser des <u>donnÃ©es au format Parquet</u> **sans les charger complÃ¨tement en mÃ©moire**.  


::: callout-note

Il faut bien distinguer le projet DuckDB du package R duckdb qui propose simplement une faÃ§on d'utiliser Duckdb avec R.

:::


## Ã€ quoi sert le package duckdb ?

Du point de vue dâ€™un statisticien utilisant R, le package duckdb permet de faire trois choses:

- Importer des donnÃ©es (exemples: fichiers CSV, fichiers Parquet)  
- Manipuler des donnÃ©es avec la syntaxe dplyr, ou avec le langage SQL  
- Ã‰crire des donnÃ©es au format Parquet.  

## Alors arrow ou duckdb ?

Tableau repris de la documentation [utilitr](https://book.utilitr.org/)

| Je souhaite...                                                            | arrow | duckdb |
| ------------------------------------------------------------------------- | ----- | ------ |
| Optimiser mes traitements pour des donnÃ©es volumineuses                   | âœ”ï¸     | âœ”ï¸     |
| Travailler sur un fichier .parquet ou .csv sans le charger entiÃ¨rement en mÃ©moire | âœ”ï¸     | âœ”ï¸     |
| Utiliser la syntaxe `dplyr` pour traiter mes donnÃ©es                      | âœ”ï¸     | âœ”ï¸     |
| Utiliser du langage SQL pour traiter mes donnÃ©es                          | âŒ     | âœ”ï¸     |
| Joindre des tables trÃ¨s volumineuses (plus de 4 Go)                          | âŒ     | âœ”ï¸     |
| Utiliser des fonctions fenÃªtres (voir @sec-arrow)                          | âŒ     | âœ”ï¸     |
| Utiliser des fonctions statistiques qui n'existent pas dans arrow (voir @sec-arrow) | âŒ     | âœ”ï¸     |
| Ã‰crire un fichier .parquet                                                | âœ”ï¸     | âœ”ï¸ *   |

## Installation de duckdb

Il suffit dâ€™installer le package duckdb, qui contient Ã  la fois DuckDB et une interface pour que R puisse sâ€™y connecter.

Bonne nouvelle sur la version de Cerise mis Ã  disposition en 2025, le package duckdb sera installÃ© par dÃ©faut ! ğŸ‰ğŸ‰ğŸ‰


## Connexions avec duckdb 

Pour utiliser duckdb, il n'est pas nÃ©cessaire de connaÃ®tre le langage SQL car il est possible d'utiliser duckdb avec la syntaxe dplyr.  

duckdb est une base de donnÃ©es distante et sâ€™utilise comme telle: il faut ouvrir une connexion, puis â€œchargerâ€ les donnÃ©es dans la base de donnÃ©es pour les manipuler.

```{.r}
con <- DBI::dbConnect(drv = duckdb::duckdb())
```

Plusieurs remarques :  

- Cette commande crÃ©e une nouvelle base de donnÃ©es duckdb dans la mÃ©moire vive. 

- Cette base de donnÃ©es ne contient aucune donnÃ©e lorsquâ€™elle est crÃ©Ã©e. Lâ€™objet conn_ddb apparaÃ®t dans lâ€™onglet Data de lâ€™environnement RStudio, mais la liste des tables nâ€™y est pas directement accessible

![](img/duckdb_fenetredata.png)
Ã€ la fin du traitement ou du programme, on ferme la connexion avec le code ci-dessous. Lâ€™option shutdown est importante : elle permet de fermer complÃ¨tement la session duckdb et de libÃ©rer la mÃ©moire utilisÃ©e.

```{.r}
DBI::dbDisconnect(con, shutdown = TRUE)
```

## AccÃ©der aux mÃ©tadonnÃ©es d'un fichier parquet avec duckdb

con <- dbConnect(duckdb())
dbGetQuery(con, "DESCRIBE FROM read_parquet('iris.parquet')")

# Le package nanoparquet permet d'obtenir des infos facilement depuis des fichiers parquet
parquet_info("iris.parquet")
parquet_metadata("iris.parquet")
parquet_schema("iris.parquet")
parquet_column_types("iris.parquet")

## duckplyr (TODO)
