---
editor: 
  markdown: 
    wrap: 72
---

# Manipuler des fichiers parquets avec duckdb {.backgroundTitre}

## Qu‚Äôest-ce que duckdb ?

DuckDB est un projet open-source qui propose un moteur SQL optimis√© pour **r√©aliser des travaux d‚Äôanalyse statistique sur des bases de donn√©es**.  

Plusieurs avantages :  

- Un **moteur portable** utilisable avec **plusieurs langages** (R, Python, Javascript...) et **plusieurs OS** (Windows, Linux, MacOS...)  
- Une **installation** et une **utilisation** tr√®s **facile**  

- Un **moteur SQL** capable d'utiliser des <u>donn√©es au format Parquet</u> **sans les charger compl√®tement en m√©moire**.  


::: callout-note

Il faut bien distinguer le projet DuckDB du package R duckdb qui propose simplement une fa√ßon d'utiliser Duckdb avec R.

:::


## √Ä quoi sert le package duckdb ?

Du point de vue d‚Äôun statisticien utilisant R, le package duckdb permet de faire trois choses:

- Importer des donn√©es (exemples: fichiers CSV, fichiers Parquet)  
- Manipuler des donn√©es avec la syntaxe dplyr, ou avec le langage SQL  
- √âcrire des donn√©es au format Parquet.  

## Alors arrow ou duckdb ?

Tableau repris de la documentation [utilitr](https://book.utilitr.org/)

| Je souhaite...                                                            | arrow | duckdb |
| ------------------------------------------------------------------------- | ----- | ------ |
| Optimiser mes traitements pour des donn√©es volumineuses                   | ‚úîÔ∏è     | ‚úîÔ∏è     |
| Travailler sur un fichier .parquet ou .csv sans le charger enti√®rement en m√©moire | ‚úîÔ∏è     | ‚úîÔ∏è     |
| Utiliser la syntaxe `dplyr` pour traiter mes donn√©es                      | ‚úîÔ∏è     | ‚úîÔ∏è     |
| Utiliser du langage SQL pour traiter mes donn√©es                          | ‚ùå     | ‚úîÔ∏è     |
| Joindre des tables tr√®s volumineuses (plus de 4 Go)                          | ‚ùå     | ‚úîÔ∏è     |
| Utiliser des fonctions fen√™tres (voir @sec-arrow)                          | ‚ùå     | ‚úîÔ∏è     |
| Utiliser des fonctions statistiques qui n'existent pas dans arrow (voir @sec-arrow) | ‚ùå     | ‚úîÔ∏è     |
| √âcrire un fichier .parquet                                                | ‚úîÔ∏è     | ‚úîÔ∏è *   |

## Installation de duckdb

Il suffit d‚Äôinstaller le package duckdb, qui contient √† la fois DuckDB et une interface pour que R puisse s‚Äôy connecter.

Bonne nouvelle sur la version de Cerise mis √† disposition en 2025, le package duckdb sera install√© par d√©faut ! üéâüéâüéâ


## Connexions avec duckdb 

Pour utiliser duckdb, il n'est pas n√©cessaire de conna√Ætre le langage SQL car il est possible d'utiliser duckdb avec la syntaxe dplyr.  

duckdb est une base de donn√©es distante et s‚Äôutilise comme telle: il faut ouvrir une connexion, puis ‚Äúcharger‚Äù les donn√©es dans la base de donn√©es pour les manipuler.

```{.r}
con <- DBI::dbConnect(drv = duckdb::duckdb())
```

Plusieurs remarques :  

- Cette commande cr√©e une nouvelle base de donn√©es duckdb dans la m√©moire vive. 

- Cette base de donn√©es ne contient aucune donn√©e lorsqu‚Äôelle est cr√©√©e. L‚Äôobjet conn_ddb appara√Æt dans l‚Äôonglet Data de l‚Äôenvironnement RStudio, mais la liste des tables n‚Äôy est pas directement accessible

![](img/duckdb_fenetredata.png)
√Ä la fin du traitement ou du programme, on ferme la connexion avec le code ci-dessous. L‚Äôoption shutdown est importante : elle permet de fermer compl√®tement la session duckdb et de lib√©rer la m√©moire utilis√©e.

```{.r}
DBI::dbDisconnect(con, shutdown = TRUE)
```

## Chargement de donn√©es issues de la session R (1/2)

La fonction `duckdb_register()` permet de charger dans duckdb des donn√©es pr√©sentes en m√©moire dans la session R.  

Cette m√©thode a l‚Äôavantage de ne pas recopier les donn√©es: elle se contente d‚Äô√©tablir un lien logique entre la base de donn√©es duckdb et un objet de la session R.  

L‚Äôobjet cr√©√© dans la base est une vue dans le catalogue "temp". La dur√©e d‚Äôexistence de cette vue est le temps de la connexion √† la base du fait qu‚Äôelle est dans un catalogue "temp".

```{.r}
# Cr√©ation de la vue "RA2020_duckdb"
con |> duckdb::duckdb_register(
  name = "RA2020_duckdb", 
  df = RA2020)
```

## Chargement de donn√©es issues de la session R (2/2)

Pour v√©rifier que le chargement des donn√©es a bien fonctionn√©, la fonction `tbl()` permet d'acc√©der √† une table de la base de donn√©es gr√¢ce √† son nom.  

```{.r}
con |> tbl("RA2020_duckdb")

# Source:   table<RA2020_duckdb> [?? x 255]
# Database: DuckDB v1.1.0 [damien.dotta@Windows 10 x64:R 4.3.0/:memory:]
   NOM_DOSSIER TYPE_QUESTIONNAIRE SEUIL_IFS CHAMP_GEO COEF_F NUMSTRATE  STRATE     SIEGENAT SIEGE_CODE_COM SIEGE_LIEUDIT      
   <chr>       <chr>              <chr>     <chr>      <dbl> <chr>      <chr>      <chr>    <chr>          <chr>              
 1 1577514     2                  1         1           1.22 2500000004 25000ERICA 10       14406          NA                 
 2 1577515     2                  1         1          10.3  2105161843 2105161843 10       51303          NA                 
 3 1577516     3                  1         2           1    0101030406 EXH_GEO    10       97407          CHEMIN DES ANGLAIS 
 4 1577517     1                  1         1           0    NA         NA         10       57733          NA                 
 5 1577524     3                  1         2           1    0101030406 EXH_GEO    32       97420          LA RUE MARCHANDE   
 6 1577526     3                  1         2           1    0101030406 EXH_GEO    10       97407          LA RIVIERE DES GAL‚Ä¶
 7 1577527     3                  1         2           1    0101030406 EXH_GEO    10       97407          LA RIVIERE DES GAL‚Ä¶
 8 1577528     3                  1         2           1    0101030406 EXH_GEO    10       97407          LA RIVIERE DES GAL‚Ä¶
 9 1577533     1                  1         1           0    NA         NA         10       28393          CHENE CHENU        
10 1577534     2                  1         1          12.0  2402815003 2402815003 10       28393          NA                 
# ‚Ñπ more rows
# ‚Ñπ 245 more variables: SIEGE_LIEUDIT_CODE_DOM <chr>, SIEGE_LIB_COM <chr>, SIEGE_DEP <chr>, SIEGE_LIB_DEP <chr>,
```

## Acc√©der aux m√©tadonn√©es d'un fichier parquet avec duckdb

con <- dbConnect(duckdb())
dbGetQuery(con, "DESCRIBE FROM read_parquet('iris.parquet')")

# Le package nanoparquet permet d'obtenir des infos facilement depuis des fichiers parquet
parquet_info("iris.parquet")
parquet_metadata("iris.parquet")
parquet_schema("iris.parquet")
parquet_column_types("iris.parquet")




## Comment acc√©der aux colonnes dans l'onglet environnement (TODO)

## duckplyr (TODO)