---
editor: 
  markdown: 
    wrap: 72
---

# Comment utiliser/interroger un fichier parquet ? {.backgroundTitre}

## Lire un fichier avec read_parquet()

```{r}
#| label: chargement_packages
#| message: false
library(dplyr)
library(arrow)
library(tictoc)
```

Pour l'exemple, nous allons prendre une table d'une centaine de MO qui
contient 518 925 lignes et 486 colonnes.

```{r}
#| label: avec_dplyr_parquet

tic()
RA2010 <- arrow::read_parquet("data/RA2010_exploitations.parquet")
toc()
```

## Comparaison avec la lecture d'un fichier rds

Voyons l'écart avec la lecture d'un fichier rds :

```{r}
#| label: avec_dplyr_rds
#| eval: false
RA2010 <- readRDS("data/RA2010_exploitations.rds")
```

Le temps nécessaire au chargement de la table est d'environ 32 secondes
!

L'écart est significatif rien que sur la lecture (X 13) et on n'a pas
commencé à manipuler des données !

## Des requêtes avec dplyr comme d'habitude

```{r}
#| label: avec_dplyr_requete

resultat <- RA2010 %>% 
  filter(region == "93") %>% 
  group_by(dep) %>% 
  summarise(total_SAU = sum(SAU, na.rm = TRUE))
resultat
```

## Bilan avec des requêtes avec dplyr

-   Le temps d'exécution de la requête est d'environ 9 secondes.
-   Les ressources consommées sont importantes

![](img/ressources_dplyr.png){fig-align="center"}
